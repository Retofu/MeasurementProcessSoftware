:imagesdir: CourseworkMedia
:figure-caption: Рисунок
:table-caption: Таблица
:toc-title: Оглавление
:toc: macro
:stem:
:eqnums: all

include::Titul.adoc[lines="1..8"]
Разработка устройства индикации напряжения +
Пояснительная записка к курсовому проекту
include::Titul.adoc[lines="11..23"]

toc::[]

== Требования к разработке

Общие требования к курсовому проекту представлены в таблице 1.

.Требования к курсовому проекту
[cols="1,1"]
|===
|Параметр, характеристика |Требование

|Отладочная плата
|XNUCLEO-F411RE

|Способ измерения напряжения
|Встроенный АЦП

|Период измерения
|50 мс

|Получение кода измерения
|Механизм DMA

|Измерение/изменение напряжения
|Плата Accessory Shield, переменный резистор

|Точность измерения напряжения
|Не менее 0,01 В

|Общение с платой расширения
|USART2

|Передача значений по беспроводному интерфейсу
|BlueTooth Bee HC-06 или I/O Expansion Shield

|Язык приложения, компилятор
|C++, ARM 8.40.2
|===

К измеренному напряжению должен быть применен цифровой фильтр вида:

stem:[tau = int  ((1-e^(-dt/(R*C)), RC > 0 sec), (1, RC<= 0 sec))] +
{nbsp} +
stem:["FilteredValue" = "OldValue" + ("Value" - "OldValue") * tau], +
{nbsp} +
где dt = 100 мс; +
Value – текущее нефильтрованное измеренное значение напряжения; +
oldValue - предыдущее фильтрованное значение.

Индикация значения измеренного напряжения должна осуществляться через включение/выключение светодиодов. При максимальном напряжении софт должен зажигать 4 светодиода, при минимальном все светодиоды должны погаснуть.

Промежуточные значения напряжения должны индицироваться следующим образом:

* при 0-25% от максимального напряжения зажигается только 1 светодиод;
* при 25-50% от максимального напряжения зажигается только 2 светодиода;
* при 50-75% от максимального напряжения зажигается только 3 светодиода;
* при 75-100% от максимального напряжения зажигается все 4 светодиода.

Формат вывода: +
   "Напряжение: " X.XXX [Units]

Архитектура должна быть представлена в виде UML диаграмм в пакете Star UML. При разработке должна использоваться Операционная Система Реального Времени FreeRTOS и RtosWrapper.

== Окружение программы

Окружение программы представлено на рисунке 1.

[#Окружение_программы]
.Окружение программы
image::GeneralPartsScheme.png[]

Описание блоков в окружении программы представлено в таблице 2.

.Описание блоков
[cols="1,1"]
|===
|Блок |Описание

|Микроконтроллер
|STM32F411RE с ядром Cortex-M4 предназначен для управления периферийными устройствами. Содержит микропроцессор, ОЗУ и ПЗУ. Есть встроенный АЦП

|Аналого-цифровой преобразователь (АЦП)
|12 битный встроенный АЦП. Нужен для измерения напряжения с переменного резистора на плате расширения

|Блок светодиодов 1-4
|Светодиоды LED1-LED4 расположены на отладочной плате.

|Переменный резистор на плате расширения
|Потенциометр необходим для изменения напряжения, а также для измерения напряжения с него. Напряжения меняется от 0 до 3,3 В

|Bluetooth Bee HC-06
|Модуль подключается по UART к разъемам RX и TX. Обеспечивает передачу данных по беспроводному интерфейсу

|USART2 / USB
|Модуль необходим для связи микроконтроллера и ПК

|ПК
|Персональный компьютер, на котором есть терминал для вывода данных с микроконтроллера

|===

== Анализ требований

В требованиях указан период измерения 50 мс, при этом цифровой фильтр должен работать с периодом 100 мс, что является не логичным. Поэтому следует увеличить период измерения до 100 мс или уменьшить период работы фильтра до 50 мс. В ходе согласования с руководителем было принято решение увеличить период измерения до периода работы фильтра, то есть до 100 мс.

Для передачи данных по беспроводному интерфейсу будет использован модуль Bluetooth Bee HC-06, так как он уже есть в наличии.

Чтобы обеспечить требуемую точность измерения напряжения не менее 0,01 В, необходимо соблюдать точность в расчетах и параметрах. Для определения максимального значения напряжения возможно измерить его с помощью точного вольтметра (с погрешностью не более 0,01 В), тем самым откалибровав измерение напряжения.

Для преобразования на АЦП напряжения с переменного резистора на плате расширения может использоваться формула:

stem:["AdcVoltageValue" = ("AdcCodeValue" * ("MaxCalibrVoltage" - "MinCalibrVoltage")) / ("MaxAdcCode" - "MinAdcCode") + "OffsetValue"], +
{nbsp} +
где AdcCodeValue - текущее измеренное значение кода с 12 битного АЦП; +
MaxCalibrVoltage – максимальное значение напряжения, которое может быть установлено потенциометром, определенное точным вольтметром; +
MinCalibrVoltage – минимальное значение напряжения, которое может быть установлено потенциометром, определенное точным вольтметром; +
MaxAdcCode - максимальное значение кода 12 битного АЦП, соответвующее MaxCalibrVoltage; +
MinAdcCode - минимальное значение кода 12 битного АЦП, соответвующее MinCalibrVoltage; +
stem:["OffsetValue" = "MaxCalibrVoltage" - "MaxAdcCode" * ("MaxCalibrVoltage" - "MinCalibrVoltage") / ("MaxAdcCode" - "MinAdcCode")]  - отклонение от нуля.

Для определения количества светодиодов для индикации значений напряжения может быть использована формула:

stem:["LEDsAmount" = ⌈("AdcVoltageValue" * "MaxLEDsAmount") / "MaxCalibrVoltage"⌉], +
{nbsp} +
где LEDsNumber - количество светодиодов, которые должны быть включены по условию из требований; +
MaxLEDsAmount - максимальное количество светодиодов, равное 4.

В ходе согласования с руководителем логика работы светодиодов была изменена. Промежуточные значения напряжения должны теперь индицироваться следующим образом:

* при 0-5% от максимального напряжения светодиоды не работают;
* при 5-25% от максимального напряжения зажигается только 1 светодиод;
* при 25-50% от максимального напряжения зажигается только 2 светодиода;
* при 50-75% от максимального напряжения зажигается только 3 светодиода;
* при 75-100% от максимального напряжения зажигается все 4 светодиода.

Тогда с учетом изменения требований для определения количества светодиодов для индикации значений напряжения логика будет следующая. Изначально всегда проверяется условие:

stem:["AdcVoltageValue" / "MaxCalibrVoltage" <= 0,05].

Если оно выполняется, то все светодиоды не включены. Если не выполняется, то используется выше приведенная формула.

К измеренному напряжению должен применяться цифровой фильтр. При постоянной времени RC = 1 с его уравнение принимает вид:

stem:[tau = int  (1-e^(-dt/(R*C)))] +
{nbsp} +
где dt = 50 мс.

Постоянная времени RC цепи это время необходимое конденсатору для того, чтобы напряжение на нем составило 63% от подаваемого напряжения, если заряд начинался с нулевого значения.

Для получения кода измерения согласно требованиям должен использоваться механизм DMA. +
Прямой доступ к памяти (Direct Memory Access, DMA) - режим обмена между устройством и основной памятью, в котором процессор не участвует. Он используется для увеличения скорости передачи, так как данные не пересылаются в процессор и обратно. Если требуется заполнить ячейки памяти, расположенные по подряд идущим адресам, используется «пакетный» режим работы шины:

* размер данных записывается в регистр контроллера DMA;
* первый цикл используется для передачи адреса первой ячейки;
* последующие циклы используются для пересылки данных указанного размера.

== Архитектура проекта

Общая архитектура проекта, выполненная в программе StarUML, представлена на рисунке 2.

[#Общая_архитектура]
.Общая архитектура проекта
image::GeneralArch.png[]

Настройка DMA и АЦП будет производиться через класс *AdcDmaDataProvider*. +
Снятое с потенциометра значение напряжения в классе *Voltage* для фильтрации будет передаваться в класс *DigitalFilter* и далее через интерфейс *IFilter* в *MeasurementTask*, а нефильтрованное значение напряжения через интерфейс *IMeasurementVariable* в класс *MeasurementTask*.

Для реализации работы USART2 и передачи по Bluetooth в классе *USART2* будут настройка регистров и обработчик прерываний USART2. Через класс *UsartDriver* информация о USART2 будут передаваться в класс *BluetoothTask*.

Для запроса передачи данных по Bluetooth будет использован интерфейс *IMeasurementVariableNotifier*, связывающий *MeasurementTask* и *BluetoothTask*. А также для подсветки нужного количества светодиодов в зависимости от напряжения будет создан класс *LEDindication*, который так же наследует интерфейс *IMeasurementVariableNotifier*.